
Перем МассивНеРедактироватьСтатусы Экспорт;

Процедура ОбработкаПроведения(Отказ, РежимПроведения)

	Перем ГодИзНомера, УНПизНомера, НомерИзНомера;
	
	Если ОбменДанными.Загрузка Тогда
		Возврат
	КонецЕсли;
	
	Движения.НомераЭСЧФ.Записывать         = Истина;
	Движения.ВходящийНДСпоЭСЧФ.Записывать  = Истина;
	
	Для каждого цСтрока Из ДокументыДляОтражения Цикл
		
		// Отражение номера
		ЭСЧФобщий.РазложитьНомер(цСтрока.НомерЭСЧФ, ГодИзНомера, УНПизНомера, НомерИзНомера);
		Движение = Движения.НомераЭСЧФ.Добавить();
		Движение.Год                    = ГодИзНомера;
		Движение.Объект                 = УНПизНомера;
		Движение.Номер                  = НомерИзНомера;
		Движение.ДатаАннулирования      = цСтрока.ДатаАннулирования;
		Движение.ДатаСовершенияОперации = цСтрока.ДатаСовершенияОперации;
		Движение.Исходный               = ( цСтрока.Тип = Перечисления.ТипыЭСЧФ.Исходный );
		Движение.Исходящий              = цСтрока.Исходящий;
		Движение.ОтобразитьПолучателю   = цСтрока.ОтобразитьПолучателю;
		Движение.Тип                    = цСтрока.Тип;
		Движение.ТипБСО                 = цСтрока.ТипБСО;
		Движение.НомерНакладной         = цСтрока.НомерНакладной;
		Движение.КодБланка              = цСтрока.КодБланка;
		Движение.СерияБланка            = цСтрока.СерияБланка;
		Движение.Дата                   = цСтрока.Дата;
		Движение.ДокументОснование      = цСтрока.Документ;
		Движение.Сумма                  = цСтрока.Сумма;
		Движение.СуммаНДС               = цСтрока.СуммаНДС;
		Движение.Акциз                  = цСтрока.Акциз;
		Движение.КЭСЧФ                  = цСтрока.КЭСЧФ;
		Движение.ВидОперации            = ВидОперации;
		Движение.Контрагент             = цСтрока.Контрагент;
		Движение.ДоговорКонтрагента     = цСтрока.ДоговорКонтрагента;
		Движение.СчетФактураПродавца    = цСтрока.СчетФактураПродавца;
		Движение.НомерЭСЧФ              = цСтрока.НомерЭСЧФ;
		// Отражение суммы
		Если Не цСтрока.Исходящий Тогда
			Движение = Движения.ВходящийНДСпоЭСЧФ.Добавить();
			Движение.Период             = цСтрока.ДатаАннулирования;//Дата;
			Движение.ПериодРегистрации  = цСтрока.ДатаСовершенияОперации;
			Движение.Организация        = Организация;
			Движение.ВидДвижения        = ВидДвиженияНакопления.Приход;
			Движение.Контрагент         = цСтрока.Контрагент;
			//Движение.ДоговорКонтрагента = цСтрока.ДоговорКонтрагента;
			Движение.НДС                = цСтрока.СуммаНДС;
		КонецЕсли;
		
	КонецЦикла;

КонецПроцедуры

Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)

	Если ОбменДанными.Загрузка Тогда
		Возврат
	КонецЕсли;
	
	Если РежимЗаписи = ПредопределенноеЗначение("РежимЗаписиДокумента.Проведение") Тогда
		
		// возможно необходимо заполнить номера электронных счетов-фактур
		Год = Год(Дата);
		УНП = СокрЛП(Организация.ИНН);
		НомерНового = ЭСЧФсервер.ПолучитьНомерНовогоЭСЧФ(Год, УНП);
		Для каждого цСтрока Из ДокументыДляОтражения Цикл
			Если Не ЗначениеЗаполнено(СтрЗаменить(цСтрока.НомерЭСЧФ,"-","")) Тогда
				цСтрока.НомерЭСЧФ = ЭСЧФобщий.СформироватьНомерЭСЧФ(УНП, Год, НомерНового);
				НомерНового = НомерНового + 1
			КонецЕсли;
		КонецЦикла;
		
	ИначеЕсли РежимЗаписи = ПредопределенноеЗначение("РежимЗаписиДокумента.ОтменаПроведения") Тогда
		
		//МассивНеРедактироватьСтатусы = Новый Массив;
		//МассивНеРедактироватьСтатусы.Добавить(ПредопределенноеЗначение("Перечисление.СтатусыЭСЧФ.Аннулирован"));
		//МассивНеРедактироватьСтатусы.Добавить(ПредопределенноеЗначение("Перечисление.СтатусыЭСЧФ.Выставлен"));
		//МассивНеРедактироватьСтатусы.Добавить(ПредопределенноеЗначение("Перечисление.СтатусыЭСЧФ.ВыставленАннулированПоставшиком"));
		//МассивНеРедактироватьСтатусы.Добавить(ПредопределенноеЗначение("Перечисление.СтатусыЭСЧФ.ВыставленПодписанПолучателем"));
		//МассивНеРедактироватьСтатусы.Добавить(ПредопределенноеЗначение("Перечисление.СтатусыЭСЧФ.НаСогласовании"));
		
		Квитанция   = РегистрыСведений.Квитанции.СоздатьМенеджерЗаписи();
		Выставления = РегистрыСведений.ВыставленныеДокументы.СоздатьМенеджерЗаписи();
		Для каждого цСтр Из ДокументыДляОтражения Цикл
			ЭСЧФобщий.РазложитьНомер(цСтр.НомерЭСЧФ, Квитанция.Год, Квитанция.Объект, Квитанция.Номер);
			Квитанция.Прочитать();
			Если Квитанция.Выбран() И МассивНеРедактироватьСтатусы.Найти(Квитанция.Статус) <> Неопределено Тогда
				ВызватьИсключение "Нельзя отменить проведения документа со строками выставленных";
			ИначеЕсли Не Квитанция.Выбран() Тогда
				ЭСЧФобщий.РазложитьНомер(цСтр.НомерЭСЧФ, Выставления.Год, Выставления.Объект, Выставления.Номер);
				Выставления.Прочитать();
				Если Выставления.Выбран() И Выставления.Принят Тогда
					ВызватьИсключение "Нельзя отменить проведения документа со строками выставленных";
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
		
	КонецЕсли;

КонецПроцедуры

МассивНеРедактироватьСтатусы = ЭСЧФобщий.НеРедактироватьСтатусы();